# Data Model: Integrated RAG Chatbot for Interactive Books

## Overview
This document defines the data models for the RAG chatbot system, based on the entities identified in the feature specification and expanded with implementation details.

## Core Entities

### 1. Book Content
Represents the textual content of books that will be processed and indexed for search functionality.

**Fields:**
- `id` (UUID): Unique identifier for the book
- `title` (String): Title of the book
- `author` (String): Author of the book
- `isbn` (String, optional): ISBN identifier
- `content_format` (Enum): Format of the book (PDF, ePub, TXT, etc.)
- `upload_date` (DateTime): Timestamp when the book was uploaded
- `status` (Enum): Processing status (PENDING, INGESTING, INDEXED, FAILED)
- `total_chunks` (Integer): Number of content chunks created from the book
- `metadata` (JSON): Additional book metadata

**Relationships:**
- One-to-many with `ContentChunk`

**Validation:**
- Title and author are required
- Status must be one of the defined enum values
- Content format must be supported

### 2. Content Chunk
Represents a segment of book content that has been processed for semantic search.

**Fields:**
- `id` (UUID): Unique identifier for the chunk
- `book_id` (UUID): Reference to the parent book
- `chunk_id` (String): Sequential identifier within the book (e.g., "chunk_001")
- `content` (Text): The actual text content of the chunk
- `vector_id` (String): Identifier in the vector database (Qdrant)
- `page_number` (Integer, optional): Original page number in the source document
- `section_title` (String, optional): Title of the section this chunk belongs to
- `position` (Integer): Position in the original text (character offset)
- `token_count` (Integer): Number of tokens in the chunk
- `hash` (String): Hash of content for deduplication purposes

**Relationships:**
- Many-to-one with `BookContent`
- One-to-many with `QueryContext`

**Validation:**
- Content must not exceed 512 tokens
- Book ID must reference an existing book
- Position must be non-negative

### 3. Chat Session
Represents an individual interaction session between a user and the Q&A system.

**Fields:**
- `id` (UUID): Unique identifier for the session
- `session_token` (String): Unique token for session identification
- `book_id` (UUID): Reference to the book being queried
- `created_at` (DateTime): Timestamp when the session was created
- `last_activity` (DateTime): Timestamp of the last interaction
- `is_active` (Boolean): Whether the session is currently active
- `user_id` (UUID, optional): Optional reference to authenticated user
- `metadata` (JSON): Additional session metadata

**Relationships:**
- Many-to-one with `BookContent`
- One-to-many with `UserQuery`

**Validation:**
- Session token must be unique
- Book ID must reference an existing book
- Last activity must be >= created_at

### 4. User Query
Represents an individual query made by a user within a chat session.

**Fields:**
- `id` (UUID): Unique identifier for the query
- `session_id` (UUID): Reference to the chat session
- `query_text` (Text): The original query text from the user
- `query_embedding` (Vector): Vector representation of the query
- `query_timestamp` (DateTime): When the query was made
- `selected_text` (Text, optional): Text selected by the user (for selected-text queries)
- `query_type` (Enum): Type of query (FULL_BOOK, SELECTED_TEXT)
- `response_id` (UUID): Reference to the corresponding response

**Relationships:**
- Many-to-one with `ChatSession`
- One-to-one with `Response`

**Validation:**
- Session ID must reference an existing session
- Query text must not be empty
- Query type must be one of the defined enum values

### 5. Response
The output generated by the system based on user queries and book content.

**Fields:**
- `id` (UUID): Unique identifier for the response
- `query_id` (UUID): Reference to the original query
- `response_text` (Text): The generated response text
- `generated_at` (DateTime): When the response was generated
- `sources` (JSON): List of source chunks used to generate the response
- `relevance_score` (Float): Relevance score (0.0 to 1.0)
- `model_used` (String): Name of the model used (e.g., command-r-plus)
- `token_usage` (JSON): Information about token usage
- `citations` (JSON): List of citations with page numbers and section titles

**Relationships:**
- Many-to-one with `UserQuery`
- Many-to-many with `ContentChunk` (via citations)

**Validation:**
- Query ID must reference an existing query
- Response text must not be empty
- Relevance score must be between 0.0 and 1.0

### 6. Query Context
Information about the specific book and selected text that provides context for responses.

**Fields:**
- `id` (UUID): Unique identifier for the context
- `query_id` (UUID): Reference to the user query
- `chunks_retrieved` (JSON): List of chunk IDs retrieved for the query
- `relevance_threshold` (Float): Threshold used for filtering relevant chunks
- `top_k` (Integer): Number of top results retrieved
- `context_text` (Text): Combined text of all relevant chunks
- `context_embedding` (Vector): Vector representation of the context
- `preprocessing_notes` (Text): Notes about how the context was prepared

**Relationships:**
- One-to-one with `UserQuery`
- Many-to-many with `ContentChunk`

**Validation:**
- Query ID must reference an existing query
- Top-k value must be positive
- Context text must not be empty

## Relationships

```
BookContent (1) -----> (Many) ContentChunk
BookContent (1) -----> (Many) ChatSession
ChatSession (1) -----> (Many) UserQuery
UserQuery (1) -----> (1) Response
UserQuery (1) -----> (1) QueryContext
ContentChunk (Many) -----> (Many) Response (via citations)
ContentChunk (Many) -----> (Many) QueryContext
```

## State Transitions

### Book Content
```
PENDING -> INGESTING -> INDEXED (success)
PENDING -> INGESTING -> FAILED (error)
```

### Chat Session
```
ACTIVE -> INACTIVE (timeout or explicit closure)
INACTIVE -> ACTIVE (new query)
```

## Indexes

### Content Chunk
- Index on `book_id` for efficient retrieval by book
- Index on `chunk_id` for direct access
- Vector index on `vector_id` in Qdrant for similarity search

### Chat Session
- Index on `session_token` for fast session lookup
- Index on `book_id` for book-specific sessions
- Index on `last_activity` for session cleanup

### User Query
- Index on `session_id` for session queries
- Index on `query_timestamp` for temporal queries

## Storage Considerations

### Vector Storage (Qdrant)
- Content chunk vectors are stored in Qdrant
- Collection named "book_content" with cosine distance
- Metadata includes chunk_id, book_id, and additional fields for filtering
- Efficient for similarity searches during query processing

### Relational Storage (PostgreSQL)
- All entities except vectors are stored in PostgreSQL
- Provides ACID compliance for transactional operations
- Enables complex queries and joins between entities
- Supports JSON fields for flexible metadata storage

## Validation Rules

1. **Cross-entity consistency**: All foreign key references must point to valid entities
2. **Data integrity**: Required fields must be present and valid
3. **Size constraints**: Content chunks must not exceed 512 tokens
4. **Relevance thresholds**: Responses must meet minimum relevance threshold (>0.7)
5. **Uniqueness**: Session tokens and book IDs must be unique
6. **Temporal consistency**: Timestamps must follow logical order